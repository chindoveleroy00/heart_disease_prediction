{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-10 offset-lg-1">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">Heart Disease Prediction Form</h2>
            </div>
            <div class="card-body">
                <p class="lead">Enter the patient information below to predict heart disease risk.</p>
                
                <form method="POST" action="{{ url_for('main.predict') }}" class="needs-validation" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <!-- Demographics Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-user"></i> Demographics</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.age.label(class="form-label") }}
                                {{ form.age(class="form-control") }}
                                {% if form.age.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.age.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.sex.label(class="form-label") }}
                                {{ form.sex(class="form-select") }}
                                {% if form.sex.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.sex.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.ethnicity.label(class="form-label") }}
                                {{ form.ethnicity(class="form-select") }}
                                {% if form.ethnicity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.ethnicity.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medical History Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-history"></i> Medical History</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3 mb-3">
                            <div class="form-check">
                                {{ form.family_history(class="form-check-input") }}
                                {{ form.family_history.label(class="form-check-label") }}
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="form-check">
                                {{ form.previous_cardiac_events(class="form-check-input") }}
                                {{ form.previous_cardiac_events.label(class="form-check-label") }}
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="form-check">
                                {{ form.diabetes_status(class="form-check-input") }}
                                {{ form.diabetes_status.label(class="form-check-label") }}
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="form-check">
                                {{ form.hypertension(class="form-check-input") }}
                                {{ form.hypertension.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vital Signs Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-heartbeat"></i> Vital Signs</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.systolic_bp.label(class="form-label") }}
                                {{ form.systolic_bp(class="form-control") }}
                                {% if form.systolic_bp.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.systolic_bp.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.diastolic_bp.label(class="form-label") }}
                                {{ form.diastolic_bp(class="form-control") }}
                                {% if form.diastolic_bp.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.diastolic_bp.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.resting_heart_rate.label(class="form-label") }}
                                {{ form.resting_heart_rate(class="form-control") }}
                                {% if form.resting_heart_rate.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.resting_heart_rate.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Physical Measurements Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-ruler"></i> Physical Measurements</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.height_cm.label(class="form-label") }}
                                {{ form.height_cm(class="form-control") }}
                                {% if form.height_cm.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.height_cm.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.weight_kg.label(class="form-label") }}
                                {{ form.weight_kg(class="form-control") }}
                                {% if form.weight_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.weight_kg.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lab Values Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-vial"></i> Laboratory Values</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.total_cholesterol.label(class="form-label") }}
                                {{ form.total_cholesterol(class="form-control") }}
                                {% if form.total_cholesterol.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.total_cholesterol.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.hdl.label(class="form-label") }}
                                {{ form.hdl(class="form-control") }}
                                {% if form.hdl.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.hdl.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.ldl.label(class="form-label") }}
                                {{ form.ldl(class="form-control") }}
                                {% if form.ldl.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.ldl.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.fasting_glucose.label(class="form-label") }}
                                {{ form.fasting_glucose(class="form-control") }}
                                {% if form.fasting_glucose.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.fasting_glucose.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.hba1c.label(class="form-label") }}
                                {{ form.hba1c(class="form-control") }}
                                {% if form.hba1c.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.hba1c.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lifestyle Factors Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-running"></i> Lifestyle Factors</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.smoking_status.label(class="form-label") }}
                                {{ form.smoking_status(class="form-select") }}
                                {% if form.smoking_status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.smoking_status.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.alcohol_per_week.label(class="form-label") }}
                                {{ form.alcohol_per_week(class="form-control") }}
                                {% if form.alcohol_per_week.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.alcohol_per_week.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.physical_activity_hours.label(class="form-label") }}
                                {{ form.physical_activity_hours(class="form-control") }}
                                {% if form.physical_activity_hours.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.physical_activity_hours.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.diet_quality.label(class="form-label") }}
                                {{ form.diet_quality(class="form-select") }}
                                {% if form.diet_quality.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.diet_quality.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.stress_level.label(class="form-label") }}
                                {{ form.stress_level(class="form-select") }}
                                {% if form.stress_level.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.stress_level.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clinical Tests Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 class="text-primary"><i class="fas fa-stethoscope"></i> Clinical Tests</h4>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.chest_pain_type.label(class="form-label") }}
                                {{ form.chest_pain_type(class="form-select") }}
                                {% if form.chest_pain_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.chest_pain_type.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                {{ form.resting_ecg.label(class="form-label") }}
                                {{ form.resting_ecg(class="form-select") }}
                                {% if form.resting_ecg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.resting_ecg.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.max_heart_rate.label(class="form-label") }}
                                {{ form.max_heart_rate(class="form-control") }}
                                {% if form.max_heart_rate.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.max_heart_rate.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.st_depression.label(class="form-label") }}
                                {{ form.st_depression(class="form-control") }}
                                {% if form.st_depression.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.st_depression.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.st_slope.label(class="form-label") }}
                                {{ form.st_slope(class="form-select") }}
                                {% if form.st_slope.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.st_slope.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.num_vessels.label(class="form-label") }}
                                {{ form.num_vessels(class="form-select") }}
                                {% if form.num_vessels.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.num_vessels.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                {{ form.thalassemia.label(class="form-label") }}
                                {{ form.thalassemia(class="form-select") }}
                                {% if form.thalassemia.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.thalassemia.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check mt-4">
                                {{ form.exercise_induced_angina(class="form-check-input") }}
                                {{ form.exercise_induced_angina.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="row mt-5">
                        <div class="col-12 text-center">
                            <div class="d-grid gap-2 d-md-block">
                                {{ form.submit(class="btn btn-primary btn-lg px-5 me-3") }}
                                <button type="reset" class="btn btn-outline-secondary btn-lg px-5">Clear Form</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Progress indicator -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true" id="progressToast" style="display: none;">
        <div class="d-flex">
            <div class="toast-body">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                Processing prediction...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form validation script
    (function () {
        'use strict'
        
        // Fetch all forms we want to apply custom validation styles to
        var forms = document.querySelectorAll('.needs-validation')
        
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    } else {
                        // Show progress toast
                        var toast = document.getElementById('progressToast')
                        if (toast) {
                            toast.style.display = 'block'
                            var bsToast = new bootstrap.Toast(toast)
                            bsToast.show()
                        }
                    }
                    
                    form.classList.add('was-validated')
                }, false)
            })
    })()
    
    // Auto-calculate BMI when height and weight change
    function calculateBMI() {
        var height = document.getElementById('height_cm')
        var weight = document.getElementById('weight_kg')
        
        if (height && weight && height.value && weight.value) {
            var heightM = height.value / 100
            var bmi = weight.value / (heightM * heightM)
            console.log('Calculated BMI:', bmi.toFixed(1))
        }
    }
    
    // Add event listeners for BMI calculation
    document.addEventListener('DOMContentLoaded', function() {
        var heightField = document.getElementById('height_cm')
        var weightField = document.getElementById('weight_kg')
        
        if (heightField) heightField.addEventListener('input', calculateBMI)
        if (weightField) weightField.addEventListener('input', calculateBMI)
    })
    
    // Form reset functionality
    document.addEventListener('DOMContentLoaded', function() {
        var resetButton = document.querySelector('button[type="reset"]')
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                // Reset form validation classes
                var form = document.querySelector('.needs-validation')
                if (form) {
                    form.classList.remove('was-validated')
                }
            })
        }
    })
</script>
{% endblock %}